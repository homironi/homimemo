---
id: 1rzo1xgl9sna9y2apleb8of4
title: Cloudflare Workersでリダイレクトを設定をする
draft: false
publishDate: 2025-09-11T10:54:00.000Z
lastModDate: 2025-09-11T10:54:00.000Z
category: Web制作
tags:
  - Cloudflare
thumbnail: /images/header/articles/1rzo1xgl9sna9y2apleb8of4.webp
description: >-
  当サイトをレンタルサーバーからCloudflare
  Workersへ移行した際に、レンタルサーバーで設定していたリダイレクトを設定しました。その時のメモです。
---
## はじめに

当サイトはリポジトリを公開しています。  
必要であれば、リポジトリもご確認いただけます！

https://github.com/homironi/homimemo

## 環境

- Next.js（SSG）：15.5.2
  - SSGなのでCloudflare側では特にNext.jsを動かすための環境は用意していません
- Cloudflare

## 静的アセットの設定

今回のサイトはSSGなので、静的アセットの配信が必要でした。  
これは設定ファイル`wrangler.jsonc`で簡単に設定できます。  
Next.jsで`/_public/`に出力されるように設定しているので、その場所に静的アセットがありますよー、と設定するだけです。

```json
{
  "name": "homimemo",
  "assets": {
    "directory": "./_public/",
  },
}
```

https://developers.cloudflare.com/workers/static-assets/routing/static-site-generation/

<TextBlock blockType="note">
Next.js側では以下のように設定して、`_public`フォルダに出力されるようにしています。
```ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  output: "export",
  distDir: "_public",
};

export default nextConfig;

```
</TextBlock>

### 末尾スラッシュなし→スラッシュありにリダイレクト

静的アセットの設定として`wrangler.jsonc`のConfigファイルで設定しました。  
`"assets"`の中で`"html_handling": "auto-trailing-slash"`を設定するだけです。  
これでローカルのpreviewをしてみてもリダイレクトされるようになります。

```json
{
  "name": "homimemo",
  "assets": {
    "directory": "./_public/",
    "html_handling": "auto-trailing-slash"
  },
}
```

https://developers.cloudflare.com/workers/static-assets/routing/advanced/html-handling/

## Cloudflareのダッシュボードでリダイレクト設定

先に画像を貼っておきます。  
Cloudflareのダッシュボードから設定することができます！  

![Cloudflareのダッシュボードのルールから設定するスクショ](/images/article/1rzo1xgl9sna9y2apleb8of4/cloudflare_rule.webp)

<TextBlock blockType="info">
他にも特定の規則に従ってまとめてリダイレクトを設定することもできます。  
ルールのテンプレートだけでもいろいろあるので確認してみるのもおすすめです！
</TextBlock>

### http→httpsへのリダイレクト

Cloudflareのダッシュボードから設定できます。

1. CloudFlareダッシュボード（アカウントホーム）
2. 該当のドメインを選択
3. ルール  
4. テンプレート
5. HTTP から HTTPS へのリダイレクト [テンプレート]

### www→wwwなしへのリダイレクト

こちらもCloudflareのダッシュボードから設定できます！

1. CloudFlareダッシュボード（アカウントホーム）
2. ドメインを選択
3. ルール
4. テンプレート
5. WWW からルートにリダイレクト [テンプレート]

## 特定のページのリダイレクト

今回CloudFlare Workersへの移行と同時にリニューアルを行い、記事のURLを変更しました。  
そのため、リニューアル前の記事URLをリニューアル後のURLにリダイレクトする目的で行いました。

数が少ない場合はCloudFlareからリダイレクトの設定ができます。  
しかし、プランによって数に上限があり、規則性があるわけでもないので一つ一つ設定するしかなかったので、今回はWorkers側で制御することにしました。

https://developers.cloudflare.com/rules/configuration-rules/#availability

### リダイレクトするworkerファイルを作る

今回は`src/workers/index.ts`というファイル名で作成しました。  
ファイルの指定は後ほど構成ファイルで行うので別の名前や別の場所でも問題ありません。

コメントを書いている通りですが、細かいところ補足していきます。

```ts
const redirects: Record<string, string> = {
  "/categories/memo/0/": "/articles/qnhckrrtrx8xv662s0ox840y/",
  "/categories/memo/1/": "/articles/63wh6phn350glrerg3fq7u31/",
  "/categories/memo/2/": "/articles/myunaxoc7w88tb3shu04jo0k/",
  // 省略
};

const errorPages: Record<number, string> = {
  404: "/404.html",
  // 省略
};

export default {
  async fetch(request, env): Promise<Response> {
    const url = new URL(request.url);

    // リダイレクト判定：ここでは末尾の/がない状態でくることもあるのでそれも考慮しておく
    if (
      redirects[url.pathname] ||
      (!url.pathname.endsWith("/") && redirects[`${url.pathname}/`])
    ) {
      const redirect = `${url.origin}${
        redirects[url.pathname] || redirects[`${url.pathname}/`]
      }`;
      return Response.redirect(redirect, 301);
    }

    try {
      const response = await env.ASSETS.fetch(request);
      return response;
    } catch {
      // fetch でエラーが出た場合は404とみなす
      const errorUrl = new URL(errorPages[404], url.origin);

      // env.ASSETS.fetchでエラーが出た場合、ここで404ページをenv.ASSETS.fetchしてもエラーになるので通常fetchで取得する
      const errorResponse = await fetch(new Request(errorUrl.toString())).catch(
        () => new Response("Not Found", { status: 404 })
      );

      return new Response(errorResponse.body, {
        status: 404,
        headers: { "Content-Type": "text/html" },
      });
    }
  },
} satisfies ExportedHandler<Env>;
```

<TextBlock blockType="note" title="Env型について">
  ローカルで`wrangler types`を実行して`Env`型生成しました。（pnpm使用しているので、`pnpm wrangler types`）  
  また、ASSETS.fetchの部分は自動生成されないため、手動でinterfaceに`ASSETS.fetch`を追加したうえでリポジトリにコミットしています。（`worker-configuration.d.ts`）
 
- [wrangler typesに関しての公式ドキュメント](https://developers.cloudflare.com/workers/languages/typescript/#generate-types)
- [env.ASSETS.fetchや静的アセットに関しての公式ドキュメント](https://developers.cloudflare.com/workers/static-assets/#how-it-works)
</TextBlock>

#### 【リダイレクト対象の判定】

まず、コメント通りですがどうもここに入ってくるときは末尾の`/`ありに統一してリダイレクトする設定にしていてもまだリダイレクトが行われていない状態で通りました。  
そのため、末尾に`/`があってもなくても引っかかるよう調整して判定しています。

その後リダイレクトの対象パスの場合は、対応するパスへリダイレクトさせます。

#### 【リダイレクト対象外のもの】

リダイレクトの対象以外は特に何もせず静的アセットへリクエストを投げればよいです。

`await env.ASSETS.fetch(request)`の結果をそのまま返せばよいだけです。

#### 【そもそも存在しないものは404】

そもそも存在しないものにアクセスした場合、`await  env.ASSETS.fetch(request)`で例外が投げられます。  
今回は「静的アセットがない⇒そもそも存在しないURLのリクエスト」です。  
そのため、try-catchで例外を捕まえられるようにし、例外をキャッチしたら404で返します。

コメントの通り、ここで404.htmlのアセットを`await env.ASSETS.fetch("/404.html")`すると例外がまた投げられてしまうので、通常の`fetch`でhtmlを取得します。  
そしてそのhtmlを404ステータスにして返します。

<TextBlock blockType="question" title="例外のキャッチをしないと？">
  例外をキャッチしたら404を返すようにしましたが、そもそも例外をキャッチしないとどうなるでしょうか？  
  この場合、無効なURLにアクセスすると「例外が発生している」という旨のCloudFlare提供の画面が表示されます。  
  明らかに異常とわかるので、404を返すようにしています。
</TextBlock>

### 構成ファイルでmainを設定する

`wrangler.jsonc`ではリダイレクトのためにエントリーポイントとなる`main`のファイルを指定します。  
先程作成したリダイレクトのファイル`src/workers/index.ts`を指定しています。

```json
{
  "name": "homimemo",
  "main": "src/workers/index.ts",
  "assets": {
    "directory": "./_public/",
    // 手動でリダイレクトしている場所があるのでnoneにすることでリダイレクトしたいものをASSETSが404を先に返してしまわないようにする
    "not_found_handling": "none",
    "html_handling": "auto-trailing-slash"
  },
}
```

ここでちょっと詰まったのが、`not_found_handling`の値です。  
最初は404に飛ばす設定を選んでいたのですが、どうもその影響で「リダイレクト予定の存在しないURL」をworker側でリダイレクトする前にCloudFlare側で404として返されてしまっていました。  
そのため、`not_found_handling`は`none`に設定して、worker側で404を返すようにしました。

以上で、リダイレクトは完了です。  
確認してみると、指定のURLをリダイレクトできているはずです！

## 参照

https://developers.cloudflare.com/workers/static-assets/routing/static-site-generation/

https://developers.cloudflare.com/workers/static-assets/routing/advanced/html-handling/

https://developers.cloudflare.com/workers/languages/typescript/#generate-types

https://developers.cloudflare.com/workers/static-assets/#how-it-works
