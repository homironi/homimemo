---
id: 1rzo1xgl9sna9y2apleb8of4
title: Cloudflare Workersでリダイレクトを設定する
draft: false
publishDate: 2025-09-12T12:03:20.000+09:00
lastModDate: 2025-09-12T12:03:20.000+09:00
category: Web制作
tags:
  - Cloudflare
thumbnail: /images/header/articles/1rzo1xgl9sna9y2apleb8of4.webp
description: >-
  当サイトをレンタルサーバーからCloudflare
  Workersへ移行した際に、レンタルサーバーで設定していたリダイレクトを設定しました。その時のメモです。
---
## はじめに

レンタルサーバーからCloudflare Workersに移行したら、リダイレクト設定で詰まった経験はありませんか？  
今回は、レンタルサーバーからCloudflare Workersに移行した際に行ったリダイレクト設定について記載しました！

当サイトはリポジトリを公開しています。  
必要であれば、リポジトリもご確認いただけます！

https://github.com/homironi/homimemo

## 環境

- Next.js（SSG）：15.5.2
  - SSGなのでCloudflare側では特にNext.jsを動かすための環境は用意していません
- Cloudflare

## 静的アセットの設定

今回のサイトはSSGなので、静的アセットの配信が必要でした。  
これは設定ファイル`wrangler.jsonc`で簡単に設定できます。  
Next.jsで`/_public/`に出力されるように設定しているので、その場所に静的アセットがありますよー、と設定するだけです。

```json
{
  "name": "homimemo",
  "assets": {
    "directory": "./_public/",
    "binding": "ASSETS",
  },
}
```

https://developers.cloudflare.com/workers/static-assets/routing/static-site-generation/

`"binding": "ASSETS",`とすることで、Workerスクリプト内で`env.ASSETS`でアクセスできます。  
今回は一部記事のURLリダイレクトのため、Workerからアクセスしたいのでこちらも設定しました。  
ここを設定しておくと、CloudflareのWorkersダッシュボードからもバインディングできていることが確認できるようになります。

https://developers.cloudflare.com/workers/static-assets/binding/#binding

<TextBlock blockType="note">
Next.js側では以下のように設定して、`_public`フォルダに出力されるようにしています。
```ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  output: "export",
  distDir: "_public",
};

export default nextConfig;

```
</TextBlock>

### 末尾スラッシュなし→スラッシュありにリダイレクト

静的アセットの設定として`wrangler.jsonc`の設定ファイルで設定しました。  
`"assets"`の中で`"html_handling": "force-trailing-slash"`を設定するだけです。  
これでローカルでプレビューをしてみてもリダイレクトされるようになります。

```json
{
  "name": "homimemo",
  "assets": {
    "directory": "./_public/",
    "binding": "ASSETS",
    "html_handling": "force-trailing-slash"
  },
}
```

https://developers.cloudflare.com/workers/static-assets/routing/advanced/html-handling/#force-trailing-slashes

## Cloudflareのダッシュボードでリダイレクト設定

先に画像を貼っておきます。  
Cloudflareのダッシュボードから設定することができます！  

![Cloudflareのダッシュボードのルールから設定するスクショ](/images/article/1rzo1xgl9sna9y2apleb8of4/cloudflare_rule.webp)

<TextBlock blockType="info">
他にも特定の規則に従ってまとめてリダイレクトを設定することもできます。  
ルールのテンプレートだけでもいろいろあるので確認してみるのもおすすめです！
</TextBlock>

### http→httpsへのリダイレクト

Cloudflareのダッシュボードから設定できます。

1. Cloudflareダッシュボード（アカウントホーム）
2. 該当のドメインを選択
3. ルール  
4. テンプレート
5. HTTP から HTTPS へのリダイレクト [テンプレート]

### www→wwwなしへのリダイレクト

こちらもCloudflareのダッシュボードから設定できます！

1. Cloudflareダッシュボード（アカウントホーム）
2. ドメインを選択
3. ルール
4. テンプレート
5. WWW からルートにリダイレクト [テンプレート]

## 特定のページのリダイレクト

今回Cloudflare Workersへの移行と同時にリニューアルを行い、記事のURLを変更しました。  
そのため、リニューアル前の記事URLをリニューアル後のURLにリダイレクトする目的で行いました。

数が少ない場合はCloudflareからリダイレクトの設定ができます。  
しかし、プランによって数に上限があり、規則性があるわけでもないので一つ一つ設定するしかなかったので、今回はWorkers側で制御することにしました。

https://developers.cloudflare.com/rules/configuration-rules/#availability

### リダイレクトするWorkerファイルを作る

今回は`src/workers/index.ts`というファイル名で作成しました。  
ファイルの指定は後ほど構成ファイルで行うので別の名前や別の場所でも問題ありません。

コメントに書いた通りですが、細かいところを補足します。

```ts
const redirects: Record<string, string> = {
  "/categories/memo/0/": "/articles/qnhckrrtrx8xv662s0ox840y/",
  "/categories/memo/1/": "/articles/63wh6phn350glrerg3fq7u31/",
  "/categories/memo/2/": "/articles/myunaxoc7w88tb3shu04jo0k/",
  // 省略
};

const errorPages: Record<number, string> = {
  404: "/404/",
  500: "/500/",
  // 省略
};

export default {
  async fetch(request, env): Promise<Response> {
    const url = new URL(request.url);

    // リダイレクト判定：ここでは末尾の/がない状態でくることもあるのでそれも考慮しておく
    if (
      redirects[url.pathname] ||
      (!url.pathname.endsWith("/") && redirects[`${url.pathname}/`])
    ) {
      const redirect = `${url.origin}${
        redirects[url.pathname] || redirects[`${url.pathname}/`]
      }`;
      return Response.redirect(redirect, 301);
    }

    const response = await env.ASSETS.fetch(request).catch(() => {
      // ASSETSのfetchで失敗した場合は500エラーを返す
      return handleErrorResponse(url.origin, 500, env);
    });
      
    if(response.status !== 200){
      return handleErrorResponse(url.origin, response.status, env);
    }

    return response;
  },
} satisfies ExportedHandler<Env>;

/**
 * エラーページを返す
 * @param origin オリジンURL
 * @param status ステータスコード
 * @param env 環境変数
 * @returns エラーページのResponse
 */
function handleErrorResponse(origin: string, status: number, env: Env): Promise<Response> {
  const errorUrl = new URL(errorPages[status], origin);
  return env.ASSETS.fetch(new Request(errorUrl.toString()));
};
```

<TextBlock blockType="info" title="Env型について">
  ローカルで`wrangler types`を実行して`Env`の型を生成しました。（pnpmを使用しているので、`pnpm wrangler types`）  （`worker-configuration.d.ts`）
 
- [wrangler typesに関しての公式ドキュメント](https://developers.cloudflare.com/workers/languages/typescript/#generate-types)
- [`binding`に関する公式ドキュメント](https://developers.cloudflare.com/workers/static-assets/binding/#binding)
</TextBlock>

#### 【リダイレクト対象の判定】

まず、コメント通りですがどうもここに入ってくるときは末尾の`/`ありに統一してリダイレクトする設定にしていてもまだリダイレクトが行われていない状態で通りました。  
そのため、末尾に`/`があってもなくても引っかかるよう調整して判定しています。

その後リダイレクトの対象パスの場合は、対応するパスへリダイレクトさせます。

#### 【リダイレクト対象外のもの】

リダイレクトの対象以外は特に何もせず静的アセットへリクエストを投げればよいです。

`await env.ASSETS.fetch(request)`の結果をそのまま返せばよいだけです。

#### 【responseで200以外が返ってきたら】

`await  env.ASSETS.fetch(request)`で200以外が返ってきたときは対応するエラーページデータ（HTML）を返すようにしました。  

`/404/`や`/500/`にエラーの場合のhtmlを出力してあります。  
なので、そのデータを取得して返すようにしています。  
URL自体はアクセスしたURLのままで、404などのエラーページが表示されます。

### 構成ファイルでmainを設定する

`wrangler.jsonc`ではリダイレクトのためにエントリーポイントとなる`main`のファイルを指定します。  
先程作成したリダイレクトのファイル`src/workers/index.ts`を指定しています。

```json
{
  "name": "homimemo",
  "main": "src/workers/index.ts",
  "assets": {
    "directory": "./_public/",
    "binding": "ASSETS",
    // 手動でリダイレクトしている場所があるのでnoneにすることでリダイレクトしたいものをASSETSが404を先に返してしまわないようにする
    "not_found_handling": "none",
    "html_handling": "force-trailing-slash"
  },
}
```

ここでちょっと詰まったのが、`not_found_handling`の値です。  
最初は404に飛ばす設定を選んでいたのですが、どうもその影響で「リダイレクト予定の存在しないURL」をWorker側でリダイレクトする前にCloudflare側で404として返されてしまっていました。  
そのため、`not_found_handling`を`none`に設定して、Worker側で404を返すようにしました。

以上で、リダイレクトは完了です。  
確認してみると、指定のURLをリダイレクトできているはずです！

## 参照

https://developers.cloudflare.com/workers/static-assets/routing/static-site-generation/

https://developers.cloudflare.com/workers/static-assets/binding/#binding

https://developers.cloudflare.com/workers/static-assets/routing/advanced/html-handling/#force-trailing-slashes

https://developers.cloudflare.com/workers/static-assets/routing/advanced/html-handling/

https://developers.cloudflare.com/rules/configuration-rules/#availability

https://developers.cloudflare.com/workers/languages/typescript/#generate-types

https://developers.cloudflare.com/workers/static-assets/#how-it-works
