---
id: 1rzo1xgl9sna9y2apleb8of4
title: Cloudflare Workersでリダイレクトを設定する
draft: false
publishDate: 2025-09-12T12:03:20.000+09:00
lastModDate: 2025-09-29T19:07:02.000+09:00
category: Web制作
tags:
  - Cloudflare
thumbnail: /images/header/articles/1rzo1xgl9sna9y2apleb8of4.webp
description: >-
  当サイトをレンタルサーバーからCloudflare
  Workersへ移行した際に、レンタルサーバーで設定していたリダイレクトを設定しました。その時のメモです。
---
## はじめに

レンタルサーバーからCloudflare Workersに移行したら、リダイレクト設定で詰まった経験はありませんか？  
今回は、レンタルサーバーからCloudflare Workersに移行した際に行ったリダイレクト設定について記載しました！

当サイトはリポジトリを公開しています。  
必要であれば、リポジトリもご確認いただけます！

https://github.com/homironi/homimemo

<TextBlock blockType="warning" title="2025/09/29 大幅改稿">
「[特定のページのリダイレクト](#特定のページのリダイレクト)」を公開時から大幅改稿しています。  
わざわざWorkerスクリプトを用意してリダイレクトを処理していましたが、CloudflareWorkersにもとからあるファイルを使うことで同じことができることに気が付きました。  
改稿前の内容は不要なため、ばっさり削除→改稿しています。
</TextBlock>

## 環境

- Next.js（SSG）：15.5.2
  - SSGなのでCloudflare側では特にNext.jsを動かすための環境は用意していません
- Cloudflare

## 静的アセットの設定

今回のサイトはSSGなので、静的アセットの配信が必要でした。  
これは設定ファイル`wrangler.jsonc`で簡単に設定できます。  
Next.jsで`/_public/`に出力されるように設定しているので、その場所に静的アセットがありますよー、と設定するだけです。

```json:wrangler.jsonc
{
  "name": "homimemo",
  "assets": {
    "directory": "./_public/",
  },
}
```

https://developers.cloudflare.com/workers/static-assets/routing/static-site-generation/

`"binding": "ASSETS",`とすることで、Workerスクリプト内で`env.ASSETS`でアクセスできます。  
今回は一部記事のURLリダイレクトのため、Workerからアクセスしたいのでこちらも設定しました。  
ここを設定しておくと、CloudflareのWorkersダッシュボードからもバインディングできていることが確認できるようになります。

https://developers.cloudflare.com/workers/static-assets/binding/#binding

<TextBlock blockType="note">
Next.js側では以下のように設定して、`_public`フォルダに出力されるようにしています。

```ts:next.config.ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  output: "export",
  distDir: "_public",
};

export default nextConfig;

```
</TextBlock>

### 末尾スラッシュなし→スラッシュありにリダイレクト

静的アセットの設定として`wrangler.jsonc`の設定ファイルで設定しました。  
`"assets"`の中で`"html_handling": "force-trailing-slash"`を設定するだけです。  
これでローカルでプレビューをしてみてもリダイレクトされるようになります。

```json:wrangler.jsonc
{
  "name": "homimemo",
  "assets": {
    "directory": "./_public/",
    "html_handling": "force-trailing-slash"
  },
}
```

https://developers.cloudflare.com/workers/static-assets/routing/advanced/html-handling/#force-trailing-slashes

## Cloudflareのダッシュボードでリダイレクト設定

先に画像を貼っておきます。  
Cloudflareのダッシュボードから設定することができます！  

![Cloudflareのダッシュボードのルールから設定するスクショ](/images/article/1rzo1xgl9sna9y2apleb8of4/cloudflare_rule.webp)

<TextBlock blockType="info">
他にも特定の規則に従ってまとめてリダイレクトを設定することもできます。  
ルールのテンプレートだけでもいろいろあるので確認してみるのもおすすめです！
</TextBlock>

### http→httpsへのリダイレクト

Cloudflareのダッシュボードから設定できます。

1. Cloudflareダッシュボード（アカウントホーム）
2. 該当のドメインを選択
3. ルール  
4. テンプレート
5. HTTP から HTTPS へのリダイレクト [テンプレート]

### www→wwwなしへのリダイレクト

こちらもCloudflareのダッシュボードから設定できます！

1. Cloudflareダッシュボード（アカウントホーム）
2. ドメインを選択
3. ルール
4. テンプレート
5. WWW からルートにリダイレクト [テンプレート]

## 特定のページのリダイレクト

今回Cloudflare Workersへの移行と同時にリニューアルを行い、記事のURLを変更しました。  
そのため、リニューアル前の記事URLをリニューアル後のURLにリダイレクトする目的で行いました。

数が少ない場合はCloudflareからリダイレクトの設定ができます。  
しかし、プランによって数に上限があり、規則性があるわけでもないので一つ一つ設定するしかなかったので、今回はWorkers側で制御することにしました。

https://developers.cloudflare.com/rules/configuration-rules/#availability

### リダイレクト用のファイルを作成する

`_redirects`というファイルを作成することでそのファイル内でリダイレクトを設定できます！

https://developers.cloudflare.com/workers/static-assets/redirects/

以下のような感じで`元のパス リダイレクト先 リダイレクトのコード`を1行ずつ設定することで可能です。

```txt:public/_redirects
/categories/memo/0/ /articles/qnhckrrtrx8xv662s0ox840y/ 301
/categories/memo/1/ /articles/63wh6phn350glrerg3fq7u31/ 301
```

Next.jsでSSGしているので`public`ディレクトリは中身がビルドデータにそのままコピーされるようになっています。（デフォルト動作）  
なので、`public/_redirects`に作成しておくことでビルド後に`_public`（`assets`で指定しているフォルダ）に`_redirects`も作成されます。

### リダイレクト用のファイルの除外

`_redirects`は`assets`のディレクトリにアップロードすべきではないそうです。

https://developers.cloudflare.com/workers/static-assets/binding/#ignoring-assets

どうも`_redirects`はCloudflare Pagesでもあったようで、Pagesからのmigrateドキュメントにも記載されていたので、それを参考に`public/.assetignore`に作成しました。

https://developers.cloudflare.com/workers/static-assets/migration-guides/migrate-from-pages/#ignoring-assets

```txt:public/.assetignore
_redirects
```

以上で、リダイレクトは完了です。  
確認してみると、指定のURLをリダイレクトできているはずです！

<TextBlock blockType="warning" title="2025/09/29 大幅改稿">
記事の最初のほうでも書きましたがここの項目は大幅改稿しています。  
改稿前は`wrangler types`でWorker用に`Env`型を生成していましたが、それを削除しました。  
`wrangler.jsonc`で`main`も不要になったので削除しています。  
逆にこれらを残していると以下のようなエラーが出てしまいます。

```txt
X [ERROR] Cannot use assets with a binding in an assets-only Worker.

Please remove the asset binding from your configuration file, or provide a Worker script in your
configuration file (`main`).
```

他でWorkerを使用するなら出ないと思うのですが、`_redirects`に変えたことで今回は完全にWorkerスクリプトが不要になったので、「`Env`もいらないのに生成しないで！ じゃあ`main`設定して！」となっているエラーです。  
同じように他でWorkerスクリプトを使用しない場合は`wrangler types`をしない（自動で行うようにしていたら削除する）というのを忘れずに！
</TextBlock>

## 参照

https://developers.cloudflare.com/workers/static-assets/routing/static-site-generation/

https://developers.cloudflare.com/workers/static-assets/binding/#binding

https://developers.cloudflare.com/workers/static-assets/routing/advanced/html-handling/#force-trailing-slashes

https://developers.cloudflare.com/workers/static-assets/routing/advanced/html-handling/

https://developers.cloudflare.com/rules/configuration-rules/#availability

https://developers.cloudflare.com/workers/static-assets/#how-it-works

https://developers.cloudflare.com/workers/static-assets/redirects/

https://developers.cloudflare.com/workers/static-assets/binding/#ignoring-assets

https://developers.cloudflare.com/workers/static-assets/migration-guides/migrate-from-pages/#ignoring-assets
