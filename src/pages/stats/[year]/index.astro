---
import type { BreadcrumbElement } from "@/components/Breadcrumbs.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import { createArticleDetailPath } from "@/lib/article";
import { createTagListPagePath } from "@/lib/article/listPage";
import { filterArticlesByTag, getAllArticles, getAllTags } from "@/lib/collection";
import { formatDate } from "@/lib/date";
import type { ArticleMeta } from "@/schemas/article/meta";
import type { Props as ArticleRatioListProps } from "../_components/ArticleRatioList.astro";
import ArticleRatioList from "../_components/ArticleRatioList.astro";
import Layout from "../_layout.astro";

interface ArticleByMonth{
  month: string;
  articles?: ArticleMeta[];
};

interface Props {
  yearArticles: ArticleMeta[];
  articlesByMonth: ArticleByMonth[];
  allArticlesLength: number;
};

/**
 * Astroã®é™çš„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç”Ÿæˆ
 */
export async function getStaticPaths(){
  const existYears = [...(new Set((await getAllArticles())
  .map(article => article.data.publishDate.getFullYear())
  .sort((a, b) => a - b)))];
  
  const allArticles: ArticleMeta[] = (await getAllArticles()).map(v=>(v.data));

  return existYears.map(year => {
  const yearArticles: ArticleMeta[] = allArticles.filter(article => article.publishDate.getFullYear() === year);
  const articlesByMonthRaw = Object.entries(Object.groupBy(yearArticles.toSorted((a, b) => a.publishDate.getTime() - b.publishDate.getTime()), article => article.publishDate.getMonth() + 1 ));
  const articlesByMonth: ArticleByMonth[] = articlesByMonthRaw.map(v=>({
    month: v[0],
    articles: v[1],
  }));

  return {
    params: { year: year.toString() },
    props: {
      yearArticles,
      articlesByMonth,
      allArticlesLength: allArticles.length,
    },
  };
});
}

const { year } = Astro.params;
const { yearArticles, articlesByMonth, allArticlesLength } = Astro.props;

const title = `${year}å¹´ã®ã‚µã‚¤ãƒˆçµ±è¨ˆ`;
const description = `${year}å¹´ã®ã‚µã‚¤ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ãŸãƒšãƒ¼ã‚¸ã§ã™ã€‚`;

const breadcrumbs: BreadcrumbElement[] = [
  {
    name: "ã‚µã‚¤ãƒˆçµ±è¨ˆ",
    href: "/stats/",
  },
  {
    name: title,
    href: `/stats/${year}/`,
  },
];

const tagsRatioListData : ArticleRatioListProps["list"] = (await getAllTags())
.map(tag=>{
  const filteredArticlesNum = filterArticlesByTag(yearArticles, tag.id).length;
  return {
    tag: tag,
    length: filteredArticlesNum,
  };})
.filter(v => v.length >= 1)
.sort((a, b)=> b.length - a.length)
.map(({tag, length})=>{
  return {
    allArticlesLength: yearArticles.length,
    length: length,
    href: createTagListPagePath(tag.id),
    name :  tag.data.name,
  };
});

const now = new Date();
---

<Layout
title={title}
description={description}
>
  <Breadcrumbs breadcrumbs={breadcrumbs}/>
  <h1>ğŸ‰ã‚µã‚¤ãƒˆçµ±è¨ˆ {year}å¹´ğŸ‰</h1>
  <time datetime={ formatDate(now, "YYYY-MM-DD") }>{formatDate(now, "YYYY/MM/DD")}ç¾åœ¨</time>
  <h2>{year}å¹´ã®è¨˜äº‹æ•°</h2>
  <p>{yearArticles.length} ä»¶</p>
  <p>ãªã‚“ã¨å…¨ã¦ã®å¹´ã®è¨˜äº‹{allArticlesLength}ä»¶ã®ã†ã¡ã€{Math.round(yearArticles.length / allArticlesLength * 100 * 10) / 10} %ãŒ{year}å¹´ã«æ›¸ã‹ã‚Œã¾ã—ãŸï¼</p>
  <h2>{year}å¹´ã®ã‚¿ã‚°ã”ã¨ã®è¨˜äº‹æ•°</h2>
  <ArticleRatioList list={ tagsRatioListData } />
  <h2>{year}å¹´ã®è¨˜äº‹</h2>
  <div>
    {articlesByMonth.map(({month, articles}) => {
      return (
        <details>
          <summary>{month}æœˆï¼š{articles?.length}ä»¶</summary>
          <ul>
            {articles?.map(meta => <li><a href={ createArticleDetailPath(meta.id) }>{meta.title}</a></li>)}
          </ul>
        </details>
      );
    })}
  </div>
</Layout>
