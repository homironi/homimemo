name: optimize svg

on:
    workflow_dispatch:
    pull_request:
        paths:
            - "public/**.svg"
            - "src/assets/**.svg"
        types: [opened, synchronize]

jobs:
  optimize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹æ¨©é™

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run script and save output
        id: run_script
        run: |
          echo "Running script..."
          # npm run svg ã®å‡ºåŠ›ã‚’å¤‰æ•°ã«æ ¼ç´
          FULL_OUTPUT=$(npm run svg)
          echo "$FULL_OUTPUT" # ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒ•ãƒ«å‡ºåŠ›ã‚’è¡¨ç¤º

          # æœ€é©åŒ–çµæœã®è¡Œã®ã¿ã‚’æŠ½å‡ºã—ã€ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã«æ•´å½¢
          # .svg: ã§å§‹ã¾ã‚Šã€Done in ... ã§çµ‚ã‚ã‚‹è¡Œã€ã¾ãŸã¯å®¹é‡æƒ…å ±ãŒå«ã¾ã‚Œã‚‹è¡Œã‚’æŠ½å‡º
          # ä¾‹: hoge.svg:
          # Done in 11 ms!
          # 0.359 KiB - 0% = 0.359 KiB
          # ã¨ã„ã†ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡ºã—ã€ãƒ•ã‚¡ã‚¤ãƒ«åã¨æœ€å¾Œã®è¡Œã ã‘ã‚’ã¾ã¨ã‚ã‚‹
          FORMATTED_OUTPUT=""
          CURRENT_FILE=""
          
          echo "$FULL_OUTPUT" | while IFS= read -r line; do
            # ãƒ•ã‚¡ã‚¤ãƒ«åãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹è¡Œã‚’æ¤œå‡º
            if [[ "$line" =~ \.svg:$ ]]; then
              CURRENT_FILE="${line%:}" # æœ«å°¾ã®':'ã‚’å‰Šé™¤ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿å–å¾—
            # å®¹é‡æƒ…å ±ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹è¡Œã‚’æ¤œå‡º
            elif [[ "$line" =~ ^[0-9]+\.[0-9]+\ KiB\ - ]]; then
              if [[ -n "$CURRENT_FILE" ]]; then
                FORMATTED_OUTPUT+="- \`${CURRENT_FILE}\`: \`$line\`\n"
                CURRENT_FILE="" # æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
              fi
            fi
          done
          
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$FORMATTED_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        id: commit_changes
        if: github.event.pull_request != null
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
 
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Changes detected! Committing..."
            git add public/**.svg src/assets/**.svg
            git commit -m "[update] optimize svg"
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
 
      - name: Comment on PR
        if: github.event.pull_request != null && steps.commit_changes.outputs.has_changes == 'true' && steps.run_script.outputs.output != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr comment "$PR_URL" --body "## SVGæœ€é©åŒ–çµæœ ğŸ“Š
            
            ä»¥ä¸‹ã®SVGãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ€é©åŒ–ã•ã‚Œã¾ã—ãŸï¼âœ¨
            
            ${{ steps.run_script.outputs.output }}
            "
